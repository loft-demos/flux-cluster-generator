apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "fcg.name" . }}
  labels:
    app.kubernetes.io/name: {{ include "fcg.name" . }}
    app.kubernetes.io/instance: {{ .Release.Name }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ include "fcg.name" . }}
      app.kubernetes.io/instance: {{ .Release.Name }}
  template:
    metadata:
      labels:
        app.kubernetes.io/name: {{ include "fcg.name" . }}
        app.kubernetes.io/instance: {{ .Release.Name }}
    spec:
      serviceAccountName: {{ include "fcg.serviceAccountName" . }}
      containers:
        - name: flux-cluster-generator
          image: "{{ .Values.image.repository }}:{{ default .Chart.AppVersion .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          args:
            - "--rsip-namespace={{ .Values.args.rsipNamespace }}"
            {{- with .Values.args.labelSelector }}
            - "--label-selector={{ . }}"
            {{- end }}
            - "--secret-key={{ .Values.args.secretKey }}"
            - "--rsip-name-prefix={{ .Values.args.rsipNamePrefix }}"
            - "--cluster-name-label-key={{ .Values.args.clusterNameKey }}"
            - "--project-label-key={{ .Values.args.projectLabelKey }}"
            {{- with .Values.args.copyLabelKeys }}
            - "--copy-label-keys={{ . }}"
            {{- end }}
            {{- with .Values.args.copyLabelPrefixes }}
            - "--copy-label-prefixes={{ . }}"
            {{- end }}
            {{- with .Values.args.namespaceLabelSelector }}
            - "--namespace-label-selector={{ . }}"
            {{- end }}
            {{- with .Values.args.watchNamespaces }}
            - "--watch-namespaces={{ . }}"
            {{- end }}
            # Correct flag names; coalesce keeps compatibility with old values keys
            - "--max-concurrent={{ coalesce .Values.args.maxConcurrent .Values.args.concurrency | default 2 }}"
            - "--cache-sync-seconds={{ coalesce .Values.args.cacheSyncSeconds .Values.args.cacheSyncTimeoutSeconds | default 120 }}"
            - "--zap-log-level={{ .Values.args.zapLogLevel | default "info" }}"
          resources:
{{- toYaml .Values.resources | nindent 12 }}
      nodeSelector:
{{- toYaml .Values.nodeSelector | nindent 8 }}
      tolerations:
{{- toYaml .Values.tolerations | nindent 8 }}
      affinity:
{{- toYaml .Values.affinity | nindent 8 }}
